<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Monitoring Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-operational { border-left: 4px solid #10b981; }
        .status-warning { border-left: 4px solid #f59e0b; }
        .status-error { border-left: 4px solid #ef4444; }
        .metric {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #6b7280;
            font-size: 0.9em;
        }
        .endpoint-list {
            list-style: none;
            padding: 0;
        }
        .endpoint-list li {
            padding: 10px;
            margin: 5px 0;
            background: #f9fafb;
            border-radius: 4px;
            font-family: monospace;
        }
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #2563eb;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .timestamp {
            color: #6b7280;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .auto-refresh {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Webhook Monitoring Dashboard</h1>
            <p>Real-time monitoring of payment gateway webhooks</p>
            <div>
                <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
                <label class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()"> Auto-refresh (30s)
                </label>
                <span class="timestamp" id="lastUpdate"></span>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card status-operational" id="systemStatus">
                <div class="metric" id="systemStatusText">CHECKING...</div>
                <div class="metric-label">System Status</div>
            </div>
            <div class="status-card">
                <div class="metric" id="pendingRetries">-</div>
                <div class="metric-label">Pending Retries</div>
            </div>
            <div class="status-card">
                <div class="metric" id="totalEndpoints">2</div>
                <div class="metric-label">Active Endpoints</div>
            </div>
            <div class="status-card">
                <div class="metric" id="uptime">-</div>
                <div class="metric-label">Uptime</div>
            </div>
        </div>

        <div class="card">
            <h3>üìä Retry Statistics</h3>
            <div id="retryStats">Loading...</div>
        </div>

        <div class="card">
            <h3>üåê Webhook Endpoints</h3>
            <ul class="endpoint-list">
                <li><strong>Midtrans:</strong> <span id="midtransEndpoint">-</span></li>
                <li><strong>DOKU:</strong> <span id="dokuEndpoint">-</span></li>
                <li><strong>Status:</strong> <span id="statusEndpoint">-</span></li>
            </ul>
        </div>

        <div class="card">
            <h3>üìà Recent Activity</h3>
            <div id="recentActivity">
                <p>Recent webhook activity will be displayed here...</p>
            </div>
        </div>

        <div id="errorContainer"></div>
    </div>

    <script>
        let autoRefreshInterval = null;
        const baseUrl = window.location.origin;

        async function fetchWebhookStatus() {
            try {
                const response = await fetch(`${baseUrl}/api/webhooks/status`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                throw new Error(`Failed to fetch webhook status: ${error.message}`);
            }
        }

        function updateUI(data) {
            // Clear any previous errors
            document.getElementById('errorContainer').innerHTML = '';

            // Update system status
            const systemStatusEl = document.getElementById('systemStatus');
            const systemStatusText = document.getElementById('systemStatusText');
            
            if (data.webhook_system === 'operational') {
                systemStatusEl.className = 'status-card status-operational';
                systemStatusText.textContent = 'OPERATIONAL';
            } else {
                systemStatusEl.className = 'status-card status-error';
                systemStatusText.textContent = 'ERROR';
            }

            // Update metrics
            document.getElementById('pendingRetries').textContent = data.retry_stats?.total_pending || 0;
            document.getElementById('lastUpdate').textContent = `Last updated: ${data.timestamp}`;

            // Update endpoints
            if (data.endpoints) {
                document.getElementById('midtransEndpoint').textContent = `${baseUrl}${data.endpoints.midtrans}`;
                document.getElementById('dokuEndpoint').textContent = `${baseUrl}${data.endpoints.doku}`;
                document.getElementById('statusEndpoint').textContent = `${baseUrl}/api/webhooks/status`;
            }

            // Update retry statistics
            const retryStatsEl = document.getElementById('retryStats');
            if (data.retry_stats) {
                let statsHtml = '<table>';
                statsHtml += '<tr><th>Metric</th><th>Value</th></tr>';
                statsHtml += `<tr><td>Total Pending</td><td>${data.retry_stats.total_pending}</td></tr>`;
                
                if (data.retry_stats.by_method && Object.keys(data.retry_stats.by_method).length > 0) {
                    statsHtml += '<tr><td colspan="2"><strong>By Payment Method:</strong></td></tr>';
                    for (const [method, count] of Object.entries(data.retry_stats.by_method)) {
                        statsHtml += `<tr><td>&nbsp;&nbsp;${method}</td><td>${count}</td></tr>`;
                    }
                }
                
                if (data.retry_stats.by_attempt && Object.keys(data.retry_stats.by_attempt).length > 0) {
                    statsHtml += '<tr><td colspan="2"><strong>By Attempt Number:</strong></td></tr>';
                    for (const [attempt, count] of Object.entries(data.retry_stats.by_attempt)) {
                        statsHtml += `<tr><td>&nbsp;&nbsp;Attempt ${attempt}</td><td>${count}</td></tr>`;
                    }
                }
                
                statsHtml += '</table>';
                retryStatsEl.innerHTML = statsHtml;
            } else {
                retryStatsEl.innerHTML = '<p>No retry statistics available</p>';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="card">
                    <div class="error">
                        <strong>Error:</strong> ${message}
                    </div>
                </div>
            `;
        }

        async function refreshData() {
            const container = document.querySelector('.container');
            container.classList.add('loading');

            try {
                const data = await fetchWebhookStatus();
                updateUI(data);
            } catch (error) {
                showError(error.message);
                console.error('Failed to refresh webhook data:', error);
            } finally {
                container.classList.remove('loading');
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(refreshData, 30000); // 30 seconds
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            
            // Set up auto-refresh by default
            document.getElementById('autoRefresh').checked = true;
            toggleAutoRefresh();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, pause auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
            } else {
                // Page is visible, resume auto-refresh if enabled
                const checkbox = document.getElementById('autoRefresh');
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000);
                    refreshData(); // Immediate refresh when page becomes visible
                }
            }
        });
    </script>
</body>
</html>